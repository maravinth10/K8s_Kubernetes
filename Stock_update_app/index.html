<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Portfolio Tracker</title>

<style>
  body { background:#0b1020; color:white; font-family:Arial; padding:20px; }
  table { width:100%; border-collapse:collapse; margin-top:20px; }
  th, td { padding:10px; border-bottom:1px solid #333; text-align:left; }
  .profit { color:#10b981; font-weight:bold; }
  .loss { color:#ef4444; font-weight:bold; }
  .totals-row td { font-weight:bold; background:#141a32; }
  input, button { padding:8px; border-radius:5px; border:0; }
  button { background:#6366f1; color:white; cursor:pointer; }
  button:hover { opacity:0.9; }
</style>
</head>

<body>

<h1>Indian Stocks Portfolio Tracker</h1>

<h2>Add Stock</h2>
<form id="addForm">
  <input id="symbol" placeholder="Symbol (TCS)" required>
  <input id="qty" type="number" placeholder="Qty" required>
  <input id="avgCost" type="number" step="0.01" placeholder="Avg Cost" required>
  <button type="submit">Add</button>
</form>

<h2>Holdings</h2>

<table>
<thead>
<tr>
  <th>Symbol</th>
  <th>Qty</th>
  <th>Avg Cost</th>
  <th>Current Price</th>
  <th>Invested</th>
  <th>Market Value</th>
  <th>P/L</th>
  <th>Action</th>
</tr>
</thead>
<tbody id="holdingsBody"></tbody>

<!-- TOTALS ROW -->
<tbody>
<tr class="totals-row">
  <td>Total</td>
  <td id="tQty"></td>
  <td id="tAvgCost"></td>
  <td id="tAvgCurrentPrice"></td>
  <td id="tInvested"></td>
  <td id="tMarket"></td>
  <td id="tPL"></td>
  <td></td>
</tr>
</tbody>
</table>


<script>
const API = window.location.origin;

// INR formatter
function fmtINR(n){
  return new Intl.NumberFormat('en-IN',{style:'currency',currency:'INR'}).format(n);
}

async function getCurrentPrice(symbol){
  const url = `${API}/get_price?symbol=${symbol}`;
  const res = await fetch(url);
  const data = await res.json();
  return data.price || 0;
}

async function loadHoldings(){
  const res = await fetch(`${API}/get_portfolio`);
  const holdings = await res.json();

  const tbody = document.getElementById("holdingsBody");
  tbody.innerHTML = "";

  let totalQty = 0;
  let totalInvested = 0;
  let totalMarket = 0;
  let totalCostSum = 0;

  for(const h of holdings){
    const currentPrice = await getCurrentPrice(h.symbol);
    const invested = h.buy_price * h.qty;
    const marketVal = currentPrice * h.qty;
    const pl = marketVal - invested;

    totalQty += h.qty;
    totalInvested += invested;
    totalMarket += marketVal;
    totalCostSum += h.buy_price * h.qty;

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${h.symbol}</td>
      <td>${h.qty}</td>
      <td>${fmtINR(h.buy_price)}</td>
      <td>${fmtINR(currentPrice)}</td>
      <td>${fmtINR(invested)}</td>
      <td>${fmtINR(marketVal)}</td>
      <td class="${pl>=0?'profit':'loss'}">${fmtINR(pl)}</td>
      <td><button onclick="delStock(${h.id})">Delete</button></td>
    `;
    tbody.appendChild(tr);
  }

  // Totals
  const avgCost = totalQty ? totalCostSum / totalQty : 0;
  const avgCurrentPrice = totalQty ? totalMarket / totalQty : 0;
  const totalPL = totalMarket - totalInvested;

  document.getElementById("tQty").innerText = totalQty;
  document.getElementById("tInvested").innerText = fmtINR(totalInvested);
  document.getElementById("tMarket").innerText = fmtINR(totalMarket);
  document.getElementById("tPL").innerHTML =
    `<span class="${totalPL>=0?'profit':'loss'}">${fmtINR(totalPL)}</span>`;
  document.getElementById("tAvgCost").innerText = fmtINR(avgCost);
  document.getElementById("tAvgCurrentPrice").innerText = fmtINR(avgCurrentPrice);
}

// Delete
async function delStock(id){
  await fetch(`${API}/delete_stock/${id}`, {method:"DELETE"});
  loadHoldings();
}

// Add
document.getElementById("addForm").onsubmit = async (e)=>{
  e.preventDefault();
  const body = {
    stock_name: symbol.value,
    symbol: symbol.value,
    buy_price: parseFloat(avgCost.value),
    qty: parseInt(qty.value)
  };
  await fetch(`${API}/add_stock`, {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify(body)
  });
  e.target.reset();
  loadHoldings();
};

loadHoldings();
</script>

</body>
</html>
